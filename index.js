const e=Object.freeze({domain:23,organization:39,repository:100}),t=t=>{const s=String(t).trim(),o=s.length,r=e.domain+e.organization+e.repository;if(o>r)throw new Error(`O tamanho máximo da URL foi excedido (${o}/${r}).`);const a=s.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)(?:\/|$)/);if(!a||!a[1]||!a[2])throw new Error("A URL do repositório é inválida.");const i={organization:a[1],repository:a[2]};if(i.organization.length>e.organization)throw new Error(`O nome da organização excedeu o tamanho de caracteres (${i.organization.length}/${e.organization}).`,{cause:400});if(i.repository.length>e.repository)throw new Error(`O nome do repositório excedeu o tamanho de caracteres (${i.repository.length}/${e.repository}).`,{cause:400});if(-1!==i.repository.indexOf("/")||-1!==i.repository.indexOf("#")||-1!==i.repository.indexOf("?"))throw new Error("Verifique a URL do repositório.",{cause:400});return i},s=Object.freeze({STAR_POINTS:1,FORK_POINTS:2,DIRECT_REPOSITORY_DEPENDENTS_POINTS:4,DIRECT_REPOSITORY_DEPENDENTS_INTERVAL:10,TOTAL_DOWNLOADS_POINTS:2,TOTAL_DOWNLOADS_INTERVAL:2e3,MONTHLY_DOWNLOADS_POINTS:3,MONTHLY_DOWNLOADS_INTERVAL:1e3,CONTRIBUTOR_POINTS:5,CLOSED_ISSUE_POINTS:2,ISSUE_PENALTY:1,MIN_INACTIVE_YEARS_FOR_PENALTY:2,INACTIVE_ISSUE_PENALTY:2e3,INACTIVE_YEAR_BASE_PENALTY:200}),o=e=>"number"==typeof e?Math.floor(e/s.MONTHLY_DOWNLOADS_INTERVAL)*s.MONTHLY_DOWNLOADS_POINTS:0,r=e=>"number"==typeof e?Math.floor(e/s.TOTAL_DOWNLOADS_INTERVAL)*s.TOTAL_DOWNLOADS_POINTS:0,a=e=>{const{contributors:t,forks:a,homebrew:i,npm:n,pypi:l,vscode:c,chocolatey:u,packagist:m,stars:p,commits:d,closedIssues:h,issues:g,repositoryDependents:f}=e;let y=0;if("number"==typeof p&&(y+=p*s.STAR_POINTS),"number"==typeof a&&(y+=a*s.FORK_POINTS),"number"==typeof t&&(y+=t*s.CONTRIBUTOR_POINTS),y+=o(n),y+=o(i),y+=o(l),y+=o(m),y+=r(c),y+=r(u),"number"==typeof h){const e=h*s.CLOSED_ISSUE_POINTS,t=Math.floor(.5*y);y+=Math.min(e,t)}if("number"==typeof f){const e=Math.floor(f/s.DIRECT_REPOSITORY_DEPENDENTS_INTERVAL)*s.DIRECT_REPOSITORY_DEPENDENTS_POINTS,t=Math.floor(.5*y);y+=Math.min(e,t)}if("string"==typeof d){const e=(e=>{const t=(new Date).getUTCFullYear(),o=e.match(/\b\d{4}\b/);if(!o)return 0;const r=t-parseInt(o[0],10);return r<s.MIN_INACTIVE_YEARS_FOR_PENALTY?0:r**2*s.INACTIVE_YEAR_BASE_PENALTY})(d);"number"==typeof g&&(y-=e>0?g*s.INACTIVE_ISSUE_PENALTY:g),y-=e}return y},i=e=>{if(e<1e3)return e.toLocaleString("pt-BR");const t=[{singular:" mil",plural:" mil"},{singular:" milhão",plural:" milhões"},{singular:" bilhão",plural:" bilhões"}];let s=Math.floor(Math.log10(e)/3);if(0===s)return e.toLocaleString("pt-BR");const o=(e/Math.pow(10,3*s)).toFixed(1).replace(".0","");return`${o}${Number(o)>=2?t[s-1].plural:t[s-1].singular}`},n=e=>{const t=Number(e.replace(/[^0-9.]/g,""))*(/k/i.test(e.replace(/mês/,""))?1e3:/m/i.test(e.replace(/mês/,""))?1e6:1);return{value:t,label:i(t)}},l={dm:{regex:/month/,replacement:"mês"},dy:{regex:/year/,replacement:"ano"},dt:void 0},c=e=>{const{registry:t,condition:s,period:o}={period:"dm",...e};return async e=>{if("function"==typeof s){const t=s(e);if(t instanceof Error)throw t}const r=await(await fetch(`https://img.shields.io/${t}/${o}/${e}.json?cacheSeconds=1`)).json(),a=l[o]?r.value.replace(l[o].regex,l[o].replacement):r.value;return n(a)}},u=c({registry:"chocolatey",period:"dt"}),m=async(e,t)=>{const s=await(await fetch(`https://img.shields.io/github/issues-closed/${e}/${t}.json?cacheSeconds=1`)).json();return n(s.value.replace(/closed/,""))},p={today:"Hoje",yesterday:"Ontem","this week":"Esta semana","this month":"Este mês","this year":"Este ano","last week":"Semana passada","last month":"Mês passado","last year":"Ano passado","two weeks ago":"Duas semanas atrás","three weeks ago":"Três semanas atrás","four weeks ago":"Quatro semanas atrás","five weeks ago":"Cinco semanas atrás","six weeks ago":"Seis semanas atrás","seven weeks ago":"Sete semanas atrás","eight weeks ago":"Oito semanas atrás","nine weeks ago":"Nove semanas atrás","ten weeks ago":"Dez semanas atrás","last sunday":"Último domingo","last monday":"Última segunda-feira","last tuesday":"Última terça-feira","last wednesday":"Última quarta-feira","last thursday":"Última quinta-feira","last friday":"Última sexta-feira","last saturday":"Último sábado",january:"Janeiro",february:"Fevereiro",march:"Março",april:"Abril",may:"Maio",june:"Junho",july:"Julho",august:"Agosto",september:"Setembro",october:"Outubro",november:"Novembro",december:"Dezembro"},d=async(e,t)=>{const s=(await(await fetch(`https://img.shields.io/github/last-commit/${e}/${t}.json?cacheSeconds=1`)).json()).value,o=new RegExp(Object.keys(p).join("|"),"gi");return s.replace(o,(e=>p[e.toLowerCase()]||e))},h=async(e,t)=>{const s=await(await fetch(`https://img.shields.io/github/contributors-anon/${e}/${t}.json?cacheSeconds=1`)).json();return n(s.value)},g=async(e,t)=>{const s=await(await fetch(`https://img.shields.io/github/forks/${e}/${t}.json?cacheSeconds=1`)).json();return n(s.value)},f=c({registry:"homebrew/installs"}),y=async(e,t)=>{const s=await(await fetch(`https://img.shields.io/github/issues/${e}/${t}.json?cacheSeconds=1`)).json();return n(s.value.replace(/open/,""))},w=async(e,t)=>{const s=await(await fetch(`https://img.shields.io/github/license/${e}/${t}.json?cacheSeconds=1`)).json();return s.value.includes("identifiable")?"Other":s.value},v=c({registry:"npm"}),b=c({registry:"packagist",condition(e){const[t,s]=e.split("/");if(!t||0===t.trim().length||!s||0===s.trim().length)return new Error("Pacote Packagist inválido.",{cause:400})}}),O=c({registry:"pypi"}),N=async(e,t)=>{try{const s=await fetch(`https://github.com/${e}/${t}/network/dependents`),o=(await s.text()).split("\n");for(let e=0;e<o.length;e++){const t=o[e].trim();if(!/^[\d,]+$/.test(t))continue;if(!(e+1<o.length&&"Repositories"===o[e+1].trim()))continue;const s=Number(t.replace(/,/g,""))||0;return{value:s,label:i(s)}}return{value:0,label:"0"}}catch{return{value:0,label:"0"}}},T=async(e,t)=>{const s=await(await fetch(`https://img.shields.io/github/stars/${e}/${t}.json?cacheSeconds=1`)).json();return n(s.value)},E=async e=>{const t=await(await fetch(`https://img.shields.io/visual-studio-marketplace/i/${e}.json?cacheSeconds=1`)).json();if(t.value.includes("rate limited by upstream service")){const t=await(async()=>{try{const t=await fetch(`https://marketplace.visualstudio.com/items?itemName=${e}`),s=(await t.text()).split("\n");for(let e=0;e<s.length;e++){const t=s[e].trim();if(!t.includes("data-reactroot"))continue;const o=" installs",r=t.indexOf(o);if(-1===r)break;let a=r;for(;a>0&&(t[a-1]>="0"&&t[a-1]<="9"||","===t[a-1]);)a--;const i=t.substring(a,r).trim();return Number(i.replace(/,/g,""))||0}return 0}catch{return 0}})();return{value:t,label:i(t)}}return n(t.value)},S=e=>{let{max:t}=e;if(!(Number.isInteger(t)&&t>0))throw new TypeError("`max` must be a positive integer");let s=0,o=0,r=0,a=[];const{onEviction:i}=e,n=new Map,l=new Array(t).fill(void 0),c=new Array(t).fill(void 0),u=new Array(t).fill(0),m=new Array(t).fill(0),p=(e,t)=>{if(e===r)return;const s=u[e],a=m[e];e===o?o=s:"get"!==t&&0===a||(u[a]=s),0!==s&&(m[s]=a),u[r]=e,m[e]=r,u[e]=0,r=e},d=()=>{const e=o,t=l[e];return null==i||i(t,c[e]),n.delete(t),l[e]=void 0,c[e]=void 0,o=u[e],0!==o&&(m[o]=0),s--,0===s&&(o=r=0),a.push(e),e};return{set(e,u){if(void 0===e)return;let m=n.get(e);void 0===m?(m=s===t?d():a.length>0?a.pop():s,n.set(e,m),l[m]=e,s++):null==i||i(e,c[m]),c[m]=u,1===s?o=r=m:p(m,"set")},get(e){const t=n.get(e);if(void 0!==t)return t!==r&&p(t,"get"),c[t]},peek:e=>{const t=n.get(e);return void 0!==t?c[t]:void 0},has:e=>n.has(e),*keys(){let e=r;for(let t=0;t<s;t++)yield l[e],e=m[e]},*values(){let e=r;for(let t=0;t<s;t++)yield c[e],e=m[e]},*entries(){let e=r;for(let t=0;t<s;t++)yield[l[e],c[e]],e=m[e]},forEach:e=>{let t=r;for(let o=0;o<s;o++){const s=l[t];e(c[t],s),t=m[t]}},delete(e){const t=n.get(e);if(void 0===t)return!1;null==i||i(e,c[t]),n.delete(e),a.push(t),l[t]=void 0,c[t]=void 0;const p=m[t],d=u[t];return 0!==p&&(u[p]=d),0!==d&&(m[d]=p),t===o&&(o=d),t===r&&(r=p),s--,!0},evict:e=>{let t=Math.min(e,s);for(;t>0;)d(),t--},clear(){if("function"==typeof i){const e=n.values();for(let t=e.next();!t.done;t=e.next())i(l[t.value],c[t.value])}n.clear(),l.fill(void 0),c.fill(void 0),a=[],s=0,o=r=0},resize:e=>{if(!(Number.isInteger(e)&&e>0))throw new TypeError("`max` must be a positive integer");if(e!==t){if(e<t){let t=r;const p=Math.min(s,e),d=s-p,h=new Array(e),g=new Array(e),f=new Array(e),y=new Array(e);for(let e=1;e<=d;e++)null==i||i(l[e],c[e]);for(let e=p-1;e>=0;e--)h[e]=l[t],g[e]=c[t],f[e]=e+1,y[e]=e-1,n.set(h[e],e),t=m[t];o=0,r=p-1,s=p,l.length=e,c.length=e,u.length=e,m.length=e;for(let e=0;e<p;e++)l[e]=h[e],c[e]=g[e],u[e]=f[e],m[e]=y[e];a=[];for(let t=p;t<e;t++)a.push(t)}else{const s=e-t;l.push(...new Array(s).fill(void 0)),c.push(...new Array(s).fill(void 0)),u.push(...new Array(s).fill(0)),m.push(...new Array(s).fill(0))}t=e}},get max(){return t},get size(){return s},get available(){return t-s}}},A={stats:S({max:1e3}),rateLimit:S({max:1e3})},I=new Set(["https://awesomeyou.io","https://www.awesomeyou.io"]),_=10,R=6e4,L=6e4,k=e=>{const t=Date.now(),s=(e=>{const t=e.headers.get("CF-Connecting-IP")||e.headers.get("X-Forwarded-For")||"UNKNOWN";return String(t).slice(0,19)})(e),o=A.rateLimit.get(s);if(o?.blocked&&t<o.resetAt)return{available:!1,remaining:0,resetAt:o.resetAt};if(!o||t-o.timestamp>=R)return A.rateLimit.set(s,{count:1,timestamp:t,blocked:!1}),{available:!0,remaining:_-1};const r=o.count+1;if(r>_){const e=t+L;return A.rateLimit.set(s,{count:r,timestamp:o.timestamp,blocked:!0,resetAt:e}),{available:!1,remaining:0,resetAt:e}}return A.rateLimit.set(s,{...o,count:r}),{available:!0,remaining:_-r}},P={packageName:/[^a-z0-9-_.@\/]/gi},D=e=>void 0===e||"string"==typeof e&&(!(e.length>64)&&!P.packageName.test(e)),$=e=>{if("string"!=typeof e)return;const t=e.trim().replace(P.packageName,"");return t||void 0};var j={async fetch(e,s){if("POST"!==e.method)return new Response("Método não permitido.",{status:405});const o=k(e),r=e.headers.get("Origin"),i="production"===s.ENVIRONMENT;if(!r||"string"!=typeof r)return new Response("Método não permitido.",{status:405});if(i&&!I.has(r))return new Response("Acesso negado.",{status:403});const n=Object.freeze({"Access-Control-Allow-Origin":i?r:"*","Access-Control-Allow-Methods":"POST","Access-Control-Allow-Headers":"Content-Type","Content-Type":"application/json; charset=utf-8","X-RateLimit-Limit":String(_),"X-RateLimit-Remaining":String(o.remaining)}),l=(e,t=200)=>new Response(JSON.stringify(e),{status:t,headers:n});try{if(!o.available)return l({message:"Limite de requisições excedido. Tente novamente mais tarde."},429);const s=await e.text(),{repositoryURL:r,...i}=JSON.parse(s);if("string"!=typeof r)return l({message:"Repositório inválido."},400);if(!D(i.npm))return l({message:"Pacote npm inválido."},400);if(!D(i.homebrew))return l({message:"Pacote Homebrew inválido."},400);if(!D(i.pypi))return l({message:"Pacote PyPi inválido."},400);if(!D(i.chocolatey))return l({message:"Pacote Chocolatey inválido."},400);if(!D(i.vscode))return l({message:"ID do Visual Code Studio Marketplace inválido."},400);if(!D(i.packagist))return l({message:"Pacote Packagist inválido."},400);const n=r.trim(),c=$(i.npm),p=$(i.homebrew),S=$(i.pypi),I=$(i.chocolatey),_=$(i.vscode),R=$(i.packagist),{organization:L,repository:k}=t(n);let P=n;return"string"==typeof c&&(P+=`:${c}`),"string"==typeof p&&(P+=`:${p}`),"string"==typeof S&&(P+=`:${S}`),"string"==typeof I&&(P+=`:${I}`),"string"==typeof _&&(P+=`:${_}`),"string"==typeof R&&(P+=`:${R}`),A.stats.has(P)?l(A.stats.get(P)):l(await(async(e,s)=>{const{repository:o,npm:r,pypi:i,homebrew:n,vscode:l,chocolatey:c,packagist:p}=e,{organization:S,repository:A}=t(o),I=Object.create(null),_=await Promise.all([w(S,A),T(S,A),g(S,A),y(S,A),m(S,A),d(S,A),h(S,A),N(S,A)]);return I.license=_[0],I.stars=_[1],I.forks=_[2],I.issues=_[3],I.closedIssues=_[4],I.commits=_[5],I.contributors=_[6],I.repositoryDependents=_[7],r&&(I.npm=await v(r)),n&&(I.homebrew=await f(n)),i&&(I.pypi=await O(i)),l&&(I.vscode=await E(l)),c&&(I.chocolatey=await u(c)),p&&(I.packagist=await b(p)),I.score=a({contributors:I?.contributors?.value,forks:I?.forks?.value,homebrew:I?.homebrew?.value,npm:I?.npm?.value,pypi:I?.pypi?.value,vscode:I?.vscode?.value,chocolatey:I?.chocolatey?.value,packagist:I?.packagist?.value,stars:I?.stars?.value,issues:I?.issues?.value,closedIssues:I?.closedIssues?.value,commits:I?.commits,repositoryDependents:I.repositoryDependents?.value}),await s({organization:S,repository:A,results:I})})({description:"",repository:n,npm:c,homebrew:p,pypi:S,chocolatey:I,vscode:_,packagist:R},(({results:e})=>{const t=a({closedIssues:e?.closedIssues?.value,contributors:e?.contributors?.value,forks:e?.forks?.value,homebrew:e?.homebrew?.value,issues:e?.issues?.value,npm:e?.npm?.value,pypi:e?.pypi?.value,stars:e?.stars?.value,commits:e?.commits,chocolatey:e?.chocolatey?.value,repositoryDependents:e?.repositoryDependents?.value,vscode:e?.vscode?.value,packagist:e?.packagist?.value}),s={...e,score:t,username:L,repository:k};return A.stats.set(P,s),{...e,score:t,username:L,repository:k}})))}catch(e){return e instanceof Error&&400===e.cause?l({message:e.message},400):("production"!==s.ENVIRONMENT&&console.error(e),l({message:"Ops! Erro interno."},500))}}};export{j as default};
