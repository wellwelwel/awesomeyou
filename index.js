const e=Object.freeze({domain:23,organization:39,repository:100}),t=t=>{const a=String(t).trim(),r=a.length,o=e.domain+e.organization+e.repository;if(r>o)throw new Error(`O tamanho máximo da URL foi excedido (${r}/${o}).`);const s=a.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)(?:\/|$)/);if(!s||!s[1]||!s[2])throw new Error("A URL do repositório é inválida.");const i={organization:s[1],repository:s[2]};if(i.organization.length>e.organization)throw new Error(`O nome da organização excedeu o tamanho de caracteres (${i.organization.length}/${e.organization}).`,{cause:400});if(i.repository.length>e.repository)throw new Error(`O nome do repositório excedeu o tamanho de caracteres (${i.repository.length}/${e.repository}).`,{cause:400});if(-1!==i.repository.indexOf("/")||-1!==i.repository.indexOf("#")||-1!==i.repository.indexOf("?"))throw new Error("Verifique a URL do repositório.",{cause:400});return i},a=Object.freeze({STAR_POINTS:1,FORK_POINTS:2,DIRECT_REPOSITORY_DEPENDENTS_POINTS:4,DIRECT_REPOSITORY_DEPENDENTS_INTERVAL:10,TOTAL_DOWNLOADS_POINTS:2,TOTAL_DOWNLOADS_INTERVAL:2e3,MONTHLY_DOWNLOADS_POINTS:3,MONTHLY_DOWNLOADS_INTERVAL:1e3,CONTRIBUTOR_POINTS:5,CLOSED_ISSUE_POINTS:2,ISSUE_PENALTY:1,MIN_INACTIVE_YEARS_FOR_PENALTY:2,INACTIVE_ISSUE_PENALTY:2e3,INACTIVE_YEAR_BASE_PENALTY:200}),r=e=>"number"==typeof e?Math.floor(e/a.MONTHLY_DOWNLOADS_INTERVAL)*a.MONTHLY_DOWNLOADS_POINTS:0,o=e=>"number"==typeof e?Math.floor(e/a.TOTAL_DOWNLOADS_INTERVAL)*a.TOTAL_DOWNLOADS_POINTS:0,s=e=>{const{contributors:t,forks:s,homebrew:i,npm:n,pypi:l,vscode:c,chocolatey:u,packagist:p,stars:m,commits:h,closedIssues:d,issues:f,repositoryDependents:g}=e;let y=0;if("number"==typeof m&&(y+=m*a.STAR_POINTS),"number"==typeof s&&(y+=s*a.FORK_POINTS),"number"==typeof t&&(y+=t*a.CONTRIBUTOR_POINTS),y+=r(n),y+=r(i),y+=r(l),y+=r(p),y+=o(c),y+=o(u),"number"==typeof d){const e=d*a.CLOSED_ISSUE_POINTS,t=Math.floor(.5*y);y+=Math.min(e,t)}if("number"==typeof g){const e=Math.floor(g/a.DIRECT_REPOSITORY_DEPENDENTS_INTERVAL)*a.DIRECT_REPOSITORY_DEPENDENTS_POINTS,t=Math.floor(.5*y);y+=Math.min(e,t)}if("string"==typeof h){const e="number"==typeof f?f:0,t=e>0,r=t?(e=>{const t=(new Date).getUTCFullYear(),r=e.match(/\b\d{4}\b/);if(!r)return 0;const o=t-parseInt(r[0],10);return o<a.MIN_INACTIVE_YEARS_FOR_PENALTY?0:o**2*a.INACTIVE_YEAR_BASE_PENALTY})(h):0;t&&(y-=r>0?e*a.INACTIVE_ISSUE_PENALTY:e),y-=r}return y},i=e=>{if(e<1e3)return e.toLocaleString("pt-BR");const t=[{singular:" mil",plural:" mil"},{singular:" milhão",plural:" milhões"},{singular:" bilhão",plural:" bilhões"}];let a=Math.floor(Math.log10(e)/3);if(0===a)return e.toLocaleString("pt-BR");const r=(e/Math.pow(10,3*a)).toFixed(1).replace(".0","");return`${r}${Number(r)>=2?t[a-1].plural:t[a-1].singular}`},n=e=>{const t=Number(e.replace(/[^0-9.]/g,""))*(/k/i.test(e.replace(/mês/,""))?1e3:/m/i.test(e.replace(/mês/,""))?1e6:1);return{value:t,label:i(t)}},l={dm:{regex:/month/,replacement:"mês"},dy:{regex:/year/,replacement:"ano"},dt:void 0},c=e=>{const{registry:t,condition:a,period:r}={period:"dm",...e};return async e=>{if("function"==typeof a){const t=a(e);if(t instanceof Error)throw t}const o=await(await fetch(`https://img.shields.io/${t}/${r}/${e}.json?cacheSeconds=1`)).json(),s=l[r]?o.value.replace(l[r].regex,l[r].replacement):o.value;return n(s)}},u=c({registry:"chocolatey",period:"dt"}),p=e=>{let{max:t}=e;if(!(Number.isInteger(t)&&t>0))throw new TypeError("`max` must be a positive integer");let a=0,r=0,o=0,s=[];const{onEviction:i}=e,n=new Map,l=new Array(t).fill(void 0),c=new Array(t).fill(void 0),u=new Array(t).fill(0),p=new Array(t).fill(0),m=(e,t)=>{if(e===o)return;const a=u[e],s=p[e];e===r?r=a:"get"!==t&&0===s||(u[s]=a),0!==a&&(p[a]=s),u[o]=e,p[e]=o,u[e]=0,o=e},h=()=>{const e=r,t=l[e];return null==i||i(t,c[e]),n.delete(t),l[e]=void 0,c[e]=void 0,r=u[e],0!==r&&(p[r]=0),a--,0===a&&(r=o=0),s.push(e),e};return{set(e,u){if(void 0===e)return;let p=n.get(e);void 0===p?(p=a===t?h():s.length>0?s.pop():a,n.set(e,p),l[p]=e,a++):null==i||i(e,c[p]),c[p]=u,1===a?r=o=p:m(p,"set")},get(e){const t=n.get(e);if(void 0!==t)return t!==o&&m(t,"get"),c[t]},peek:e=>{const t=n.get(e);return void 0!==t?c[t]:void 0},has:e=>n.has(e),*keys(){let e=o;for(let t=0;t<a;t++)yield l[e],e=p[e]},*values(){let e=o;for(let t=0;t<a;t++)yield c[e],e=p[e]},*entries(){let e=o;for(let t=0;t<a;t++)yield[l[e],c[e]],e=p[e]},forEach:e=>{let t=o;for(let r=0;r<a;r++){const a=l[t];e(c[t],a),t=p[t]}},delete(e){const t=n.get(e);if(void 0===t)return!1;null==i||i(e,c[t]),n.delete(e),s.push(t),l[t]=void 0,c[t]=void 0;const m=p[t],h=u[t];return 0!==m&&(u[m]=h),0!==h&&(p[h]=m),t===r&&(r=h),t===o&&(o=m),a--,!0},evict:e=>{let t=Math.min(e,a);for(;t>0;)h(),t--},clear(){if("function"==typeof i){const e=n.values();for(let t=e.next();!t.done;t=e.next())i(l[t.value],c[t.value])}n.clear(),l.fill(void 0),c.fill(void 0),s=[],a=0,r=o=0},resize:e=>{if(!(Number.isInteger(e)&&e>0))throw new TypeError("`max` must be a positive integer");if(e!==t){if(e<t){let t=o;const m=Math.min(a,e),h=a-m,d=new Array(e),f=new Array(e),g=new Array(e),y=new Array(e);for(let e=1;e<=h;e++)null==i||i(l[e],c[e]);for(let e=m-1;e>=0;e--)d[e]=l[t],f[e]=c[t],g[e]=e+1,y[e]=e-1,n.set(d[e],e),t=p[t];r=0,o=m-1,a=m,l.length=e,c.length=e,u.length=e,p.length=e;for(let e=0;e<m;e++)l[e]=d[e],c[e]=f[e],u[e]=g[e],p[e]=y[e];s=[];for(let t=m;t<e;t++)s.push(t)}else{const a=e-t;l.push(...new Array(a).fill(void 0)),c.push(...new Array(a).fill(void 0)),u.push(...new Array(a).fill(0)),p.push(...new Array(a).fill(0))}t=e}},get max(){return t},get size(){return a},get available(){return t-a}}},m={GitHub:p({max:1e3})},h=(()=>{try{return process?.env||Object.create(null)}catch(e){return Object.create(null)}})().GITHUB_TOKEN,d=async e=>{const t=m.GitHub.get(e);if(t)return t;const a={...h?{Authorization:`Bearer ${h}`}:Object.create(null),Accept:"application/vnd.github+json","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36"},r=await fetch(`https://api.github.com/${e}`,{headers:a});if(!r.ok)throw new Error("GitHub API error");const o=r.json();return m.GitHub.set(e,o),o},f=e=>new Promise(t=>setTimeout(t,e)),g=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/issues-closed/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){a=n(o.value.replace(/closed/,""));break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{const a=await d(`search/issues?q=is:issue+is:closed+repo:${e}/${t}`),r=Number(a.total_count);return{value:r,label:r.toLocaleString()}})(e,t)}catch{}return a||{value:0,label:"0"}},y={today:"Hoje",yesterday:"Ontem","this week":"Esta semana","this month":"Este mês","this year":"Este ano","last week":"Semana passada","last month":"Mês passado","last year":"Ano passado","two weeks ago":"Duas semanas atrás","three weeks ago":"Três semanas atrás","four weeks ago":"Quatro semanas atrás","last sunday":"Último domingo","last monday":"Última segunda-feira","last tuesday":"Última terça-feira","last wednesday":"Última quarta-feira","last thursday":"Última quinta-feira","last friday":"Última sexta-feira","last saturday":"Último sábado",january:"Janeiro",february:"Fevereiro",march:"Março",april:"Abril",may:"Maio",june:"Junho",july:"Julho",august:"Agosto",september:"Setembro",october:"Outubro",november:"Novembro",december:"Dezembro"},b=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/last-commit/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){const e=o.value,t=new RegExp(`^${Object.keys(y).join("|")}$`,"gi");a=e.replace(t,e=>y[e.toLowerCase()]||e);break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{const a=await d(`repos/${e}/${t}/commits?per_page=1&page=1`);if("string"!=typeof a?.[0].commit?.author?.date)return"";const r=new Date(a[0].commit.author.date),o=(new Date).getTime()-r.getTime(),s=Math.floor(o/864e5),i=Math.floor(s/7);return{today:()=>"Hoje",yesterday:()=>"Ontem",thisWeek:()=>"Esta semana",lastWeek:()=>"Semana passada",multipleWeeks:()=>`${i} semanas atrás`,lastMonth:()=>"Mês passado",monthYear:()=>new Intl.DateTimeFormat("pt-BR",{month:"long",year:"numeric"}).format(r).replace(/^\w/,e=>e.toUpperCase()).replace(" de "," ")}[0===s?"today":1===s?"yesterday":s<7?"thisWeek":s<30?1===i?"lastWeek":"multipleWeeks":s<365&&i<=4?"lastMonth":"monthYear"]()})(e,t)}catch{}return a||"Ops, falha na API"},v=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/contributors-anon/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){a=n(o.value);break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{let a=1,r=0;for(;;){const o=await d(`repos/${e}/${t}/contributors?per_page=100&page=${a}`);if(r+=o.length,o.length<100)break;a++}return{value:r,label:r.toLocaleString()}})(e,t)}catch{}return a||{value:0,label:"0"}},w=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/forks/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){a=n(o.value);break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{const a=await d(`repos/${e}/${t}`),r=Number(a.forks_count);return{value:r,label:r.toLocaleString()}})(e,t)}catch{}return a||{value:0,label:"0"}},O=c({registry:"homebrew/installs"}),N=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/issues/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){a=n(o.value.replace(/open/,""));break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{const a=await d(`search/issues?q=is:issue+is:open+repo:${e}/${t}`),r=Number(a.total_count);return{value:r,label:r.toLocaleString()}})(e,t)}catch{}return a||{value:0,label:"0"}},S=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/license/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){a=o.value.includes("identifiable")?"Other":o.value;break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{const a=await d(`repos/${e}/${t}`),r=a?.license;return r?String(r?.spdx_id).includes("NOASSERTION")?"Other":String(r?.spdx_id||"Other"):"not specified"})(e,t)}catch{}return a||"Other"},T=c({registry:"npm"}),E=c({registry:"packagist",condition(e){const[t,a]=e.split("/");if(!t||0===t.trim().length||!a||0===a.trim().length)return new Error("Pacote Packagist inválido.",{cause:400})}}),A=c({registry:"pypi"}),k=async(e,t)=>{try{const a=await fetch(`https://github.com/${e}/${t}/network/dependents`),r=(await a.text()).split("\n");for(let e=0;e<r.length;e++){const t=r[e].trim();if(!/^[\d,]+$/.test(t))continue;if(!(e+1<r.length&&"Repositories"===r[e+1].trim()))continue;const a=Number(t.replace(/,/g,""))||0;return{value:a,label:i(a)}}return{value:0,label:"0"}}catch{return{value:0,label:"0"}}},_=async(e,t)=>{let a,r=0;for(;r<10;){r++;const o=await(await fetch(`https://img.shields.io/github/stars/${e}/${t}.json?cacheSeconds=1`)).json();if("Unable to select next GitHub token from pool"!==o.value&&"invalid"!==o.value){a=n(o.value);break}if(r>=10)break;await f(1010)}if(!a)try{a=await(async(e,t)=>{const a=await d(`repos/${e}/${t}`),r=Number(a.stargazers_count);return{value:r,label:r.toLocaleString()}})(e,t)}catch{}return a||{value:0,label:"0"}},I=async e=>{const t=await(await fetch(`https://img.shields.io/visual-studio-marketplace/i/${e}.json?cacheSeconds=1`)).json();if(t.value.includes("rate limited by upstream service")){const t=await(async()=>{try{const t=await fetch(`https://marketplace.visualstudio.com/items?itemName=${e}`),a=(await t.text()).split("\n");for(let e=0;e<a.length;e++){const t=a[e].trim();if(!t.includes("data-reactroot"))continue;const r=" installs",o=t.indexOf(r);if(-1===o)break;let s=o;for(;s>0&&(t[s-1]>="0"&&t[s-1]<="9"||","===t[s-1]);)s--;const i=t.substring(s,o).trim();return Number(i.replace(/,/g,""))||0}return 0}catch{return 0}})();return{value:t,label:i(t)}}return n(t.value)},$={stats:p({max:1e3}),rateLimit:p({max:1e3})},L=new Set(["https://awesomeyou.io","https://www.awesomeyou.io"]),R=10,P=6e4,D=6e4,x=e=>{const t=Date.now(),a=(e=>{const t=e.headers.get("CF-Connecting-IP")||e.headers.get("X-Forwarded-For")||"UNKNOWN";return String(t).slice(0,19)})(e),r=$.rateLimit.get(a);if(r?.blocked&&t<r.resetAt)return{available:!1,remaining:0,resetAt:r.resetAt};if(!r||t-r.timestamp>=P)return $.rateLimit.set(a,{count:1,timestamp:t,blocked:!1}),{available:!0,remaining:R-1};const o=r.count+1;if(o>R){const e=t+D;return $.rateLimit.set(a,{count:o,timestamp:r.timestamp,blocked:!0,resetAt:e}),{available:!1,remaining:0,resetAt:e}}return $.rateLimit.set(a,{...r,count:o}),{available:!0,remaining:R-o}},M={packageName:/[^a-z0-9-_.@\/]/gi},j=e=>void 0===e||"string"==typeof e&&(!(e.length>64)&&!M.packageName.test(e)),C=e=>{if("string"!=typeof e)return;const t=e.trim().replace(M.packageName,"");return t||void 0};var U={async fetch(e,a){if("POST"!==e.method)return new Response("Método não permitido.",{status:405});const r=x(e),o=e.headers.get("Origin"),i="production"===a.ENVIRONMENT;if(!o||"string"!=typeof o)return new Response("Método não permitido.",{status:405});if(i&&!L.has(o))return new Response("Acesso negado.",{status:403});const n=Object.freeze({"Access-Control-Allow-Origin":i?o:"*","Access-Control-Allow-Methods":"POST","Access-Control-Allow-Headers":"Content-Type","Content-Type":"application/json; charset=utf-8","X-RateLimit-Limit":String(R),"X-RateLimit-Remaining":String(r.remaining)}),l=(e,t=200)=>new Response(JSON.stringify(e),{status:t,headers:n});try{if(!r.available)return l({message:"Limite de requisições excedido. Tente novamente mais tarde."},429);const a=await e.text(),{repositoryURL:o,...i}=JSON.parse(a);if("string"!=typeof o)return l({message:"Repositório inválido."},400);if(!j(i.npm))return l({message:"Pacote npm inválido."},400);if(!j(i.homebrew))return l({message:"Pacote Homebrew inválido."},400);if(!j(i.pypi))return l({message:"Pacote PyPi inválido."},400);if(!j(i.chocolatey))return l({message:"Pacote Chocolatey inválido."},400);if(!j(i.vscode))return l({message:"ID do Visual Code Studio Marketplace inválido."},400);if(!j(i.packagist))return l({message:"Pacote Packagist inválido."},400);const n=o.trim(),c=C(i.npm),p=C(i.homebrew),m=C(i.pypi),h=C(i.chocolatey),d=C(i.vscode),f=C(i.packagist),{organization:y,repository:L}=t(n);let R=n;return"string"==typeof c&&(R+=`:${c}`),"string"==typeof p&&(R+=`:${p}`),"string"==typeof m&&(R+=`:${m}`),"string"==typeof h&&(R+=`:${h}`),"string"==typeof d&&(R+=`:${d}`),"string"==typeof f&&(R+=`:${f}`),$.stats.has(R)?l($.stats.get(R)):l(await(async(e,a)=>{const{repository:r,npm:o,pypi:i,homebrew:n,vscode:l,chocolatey:c,packagist:p}=e,{organization:m,repository:h}=t(r),d=Object.create(null),f=await Promise.all([S(m,h),_(m,h),w(m,h),N(m,h),g(m,h),b(m,h),v(m,h),k(m,h)]);return d.license=f[0],d.stars=f[1],d.forks=f[2],d.issues=f[3],d.closedIssues=f[4],d.commits=f[5],d.contributors=f[6],d.repositoryDependents=f[7],o&&(d.npm=await T(o)),n&&(d.homebrew=await O(n)),i&&(d.pypi=await A(i)),l&&(d.vscode=await I(l)),c&&(d.chocolatey=await u(c)),p&&(d.packagist=await E(p)),d.score=s({contributors:d?.contributors?.value,forks:d?.forks?.value,homebrew:d?.homebrew?.value,npm:d?.npm?.value,pypi:d?.pypi?.value,vscode:d?.vscode?.value,chocolatey:d?.chocolatey?.value,packagist:d?.packagist?.value,stars:d?.stars?.value,issues:d?.issues?.value,closedIssues:d?.closedIssues?.value,commits:d?.commits,repositoryDependents:d.repositoryDependents?.value}),await a({organization:m,repository:h,results:d})})({description:"",repository:n,npm:c,homebrew:p,pypi:m,chocolatey:h,vscode:d,packagist:f},({results:e})=>{const t=s({closedIssues:e?.closedIssues?.value,contributors:e?.contributors?.value,forks:e?.forks?.value,homebrew:e?.homebrew?.value,issues:e?.issues?.value,npm:e?.npm?.value,pypi:e?.pypi?.value,stars:e?.stars?.value,commits:e?.commits,chocolatey:e?.chocolatey?.value,repositoryDependents:e?.repositoryDependents?.value,vscode:e?.vscode?.value,packagist:e?.packagist?.value}),a={...e,score:t,username:y,repository:L};return $.stats.set(R,a),{...e,score:t,username:y,repository:L}}))}catch(e){return e instanceof Error&&400===e.cause?l({message:e.message},400):("production"!==a.ENVIRONMENT&&console.error(e),l({message:"Ops! Erro interno."},500))}}};export{U as default};
